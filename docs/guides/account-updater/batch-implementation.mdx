---
title: Batch Implementation
---

import {Alert, Alerts} from "@site/src/components/shared/Alert";
import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";

# Batch Implementation

This guide provides an overview of how to implement Batch Account Updater. It covers the entire process, from initial setup to creating the batch job, generating and uploading the input request file, downloading the batch job results, and processing the results.

## Initial Setup

First, ensure that you have completed the [Account Updater Setup](/docs/guides/account-updater/setup) guide.

### Private Application

Create a **Private Application** for your backend system to create and manage Account Updater batch jobs in your tenant.

**Permissions Required:**
- `account-updater:job:create`
- `account-updater:job:read`

[Click here to create the Private Application](https://portal.basistheory.com/applications/create?type=private&permissions=account-updater%3Ajob%3Acreate&permissions=account-updater%3Ajob%3Aread&name=Batch+Account+Updater)

***Important:** Save the generated API Key. You'll use it later in this guide.*

### Configure Webhooks (Optional)

Configure a [webhook](/docs/api/webhooks) to receive notifications for job status changes. You are able to subscribe to the following event types:

- [account-updater.job.created](/docs/api/webhooks/eventdata#job-created)
- [account-updater.job.completed](/docs/api/webhooks/eventdata#job-completed)
- [account-updater.job.failed](/docs/api/webhooks/eventdata#job-failed)

## Create Batch Job

Start by [creating an Account Updater Batch Job](/docs/api/account-updater/batch/#create-account-updater-batch-job) which responds with an [Account Updater Job](#account-updater-job).
We will use the `upload_url` in the response below to [upload a request CSV file](#upload-request-file) for processing.

You have one hour to upload a request file, at which time the job and upload url will expire. If a job expires before uploading the request file, simply start the process again by creating a new job.

## Create Request File

Next we must create a [request CSV file](/docs/api/account-updater/batch/#request-file-format) containing the `card` tokens you would like to update.

If your `card` tokens include an expiration date, you may omit the `expiration_month` and `expiration_year` fields.

Test tenants can always omit the `merchant_id` field -- only include `merchant_id` in production requests IF Basis Theory explicitly instructed you to do so during Account Updater onboarding.

When testing, you can simulate various scenarios using the [Account Updater Test Cards](/docs/api/account-updater/testing#test-cards).
You can either use the API to [create tokens](/docs/api/tokens/#create-token) containing these test card numbers, or use [this script](/docs/api/account-updater/testing#generating-test-tokens) to quickly generate test `card` tokens within your test tenant.

**Example Request File**

```csv
token,expiration_year,expiration_month,merchant_id
d2cbc1b4-5c3a-45a3-9ee2-392a1c475ab4,,,
f32bc1b4-5c3a-45a3-9ee2-392a1c475d53,,,
```

<Alert> The maximum supported request file size is 30 MB per file (approx. 300k tokens). If you need to update more than 300k tokens at a time, you can split your request into multiple files and create multiple jobs in parallel.</Alert>

## Upload Request File

Once you have created a request CSV file, you can use the `upload_url` received when [creating the batch job](#create-batch-job) to submit your file for processing.
You can use the `upload_url` to upload your file using any usage patterns supported by [S3 pre-signed URLs](https://docs.aws.amazon.com/AmazonS3/latest/userguide/PresignedUrlUploadObject.html).

<Tabs className="bt-tabs" groupId="languages">
  <TabItem value="shell" label="cURL">
    ```shell showLineNumbers
    curl -X PUT -T "/local/path/to/file" "https://bt-prod-us-east-2-account-updater-data.s3.us-east-2.amazonaws.com/..."
    ```
  </TabItem>
  <TabItem value="node" label="Node">
    ```jsx
    const fileName = `.data/${jobId}/request.csv`; // create your csv request file here
    const fileStats = fs.statSync(fileName);

    const response = await fetch(uploadUrl, {
    method: 'PUT',
    headers: {
    'Content-Type': 'text/csv',
    'Content-Length': fileStats.size,
  },
    body: fs.createReadStream(fileName),
    duplex: 'half',
  });
    ```
  </TabItem>
</Tabs>

## Wait for Job Completion

There are two ways to receive notifications about the status of your batch jobs:

1. (Preferred) Configure [webhooks](#configure-webhooks-optional) to receive an [account-updater.job.completed](/docs/api/webhooks/eventdata#job-completed) event when the job is completed.
2. Poll the [Get Account Updater Job](/docs/api/account-updater/batch/#get-account-updater-job) endpoint and wait for the job `status` to change to `completed`.

### Job Timing

| Tenant Type | Job Completion Time                    |
|-------------|----------------------------------------|
| Test        | Near real-time                         |
| Production  | Typically 1 day, can take up to 7 days |

Production jobs may take longer to complete and are dependent on the card networks' processing times, which can take up to 7 days.

We recommend submitting your batch jobs at least 7 days before any recurring transactions are scheduled to ensure the update has time to complete.

## Download Result File

Once a job is in the `completed` status, you can use the `download_url` returned when [retrieving a job](/docs/api/account-updater/batch/#get-account-updater-job) to download the [Result File](/docs/api/account-updater/batch/#result-file-format).

You may use any usage patterns supported by [S3 pre-signed URLs](https://docs.aws.amazon.com/AmazonS3/latest/userguide/using-presigned-url.html) to download this file.

<Tabs className="bt-tabs" groupId="languages">
  <TabItem value="shell" label="cURL">
    ```shell showLineNumbers
    curl -o "output-file-name" "https://bt-prod-us-east-2-account-updater-data.s3.us-east-2.amazonaws.com/..."
    ```
  </TabItem>
  <TabItem value="node" label="Node">
    ```javascript showLineNumbers
    await axios.get("https://bt-prod-us-east-2-account-updater-data.s3.us-east-2.amazonaws.com/...", {responseType: 'stream'})
    .then(response => {
    // Create a write stream to save the file
    const writer = fs.createWriteStream("results.csv");

    // Pipe the response stream into the write stream
    response.data.pipe(writer);

    // Return a promise that resolves when the file has been downloaded
    return new Promise((resolve, reject) => {
    writer.on('finish', resolve);
    writer.on('error', reject);
  });
  })
    ```
  </TabItem>
</Tabs>


## Processing the Result File

The [Result File](/docs/api/account-updater/batch/#result-file-format) contains the results of the batch job, including a [result_code](/docs/api/account-updater/result-codes) for each row.
Process this file in your system and take appropriate actions based on the result codes - note that some warnings may require additional action on your part.

Rows that received an update will contain the `new_card` field with the id of a new `card` token. The token references in your system should be updated accordingly, and this new token should be used for future transactions.
You have the option to retain the old token that was replaced or [delete it](/docs/api/tokens/#delete-token) once it is no longer needed.

Rows that did not result in any updates (i.e. the `NO_UPDATE` result code), warnings, or errors are omitted from the result file.
