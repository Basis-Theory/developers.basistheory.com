---
toc_max_heading_level: 2
---

import { Alert, Alerts } from "@site/src/components/shared/Alert";

# Accept Apple Pay

This guide will walk you through the process of accepting Apple Pay in your website or iOS app, while leveraging Basis Theory platform to perform all necessary operations in PCI-sensitive data.

<Alert type={Alerts.INFO}>
  If you haven't yet, please take a look at the [Apple Pay Setup guide](/docs/guides/apple-pay/setup) to make sure you have all the necessary resources in place before you can start integrating.
</Alert>

First let's take a look at the Apple Pay integration workflow of the two types of transactions: Customer Initiated Transactions (CIT) and Merchant Initiated Transactions (MIT).

## Customer Initiated Transactions (CIT)

This type of transaction occurs when the consumer provides their payment details to the merchant, authorizing a specific transaction. Apple Pay has an interface called Payment Sheet, which you can customize to present details about the CIT, such as amount, description of the product(s) or service(s) being sold, coupons, ability to select delivery and billing address, etc.

When the user clicks the Apple "Pay" button, a sequence of interactions is initiated in three high-level steps:

1. Create Apple Pay Session - the client application (iOS or Web) initiates the Apple Pay Session by specifying the Payment Request object to present the Payment Sheet, which can contain both CIT and MIT information. In case of Web, a merchant validation is necessary in the server-side.
2. Decrypt Apple Pay Token - technically referred to as `PKPaymentToken`, this object carries encrypted payment information such as DPAN, expiration date, transaction cryptogram, cardholder name, etc. Decryption and storage of the sensitive cardholder data is performed in Basis Theory environment, to prevent you having any PCI scope in your system.
3. Process Payment - the Basis Theory tokens are forwarded to the Payment Processor via Basis Theory Proxy, which translate them back to raw data before sending the request. When the successful Payment Response returns, the client application can complete the payment with Apple libraries, which plays the satisfying "ding" and âœ… animation for the user.

```mermaid
  sequenceDiagram
    title Customer Initiated Transactions (CIT)

    actor u as User
    participant app as Client Application
    participant sa as Server Application
    participant btr as Basis Theory <br> Reactor
    participant btp as Basis Theory <br> Proxy
    participant psp as Payment Processor

    note over u, sa: Step 1 - Create Apple Pay Session
    u ->>+ app:  Click "Pay" button
    activate u
    app ->> app: Initiate Apple Pay Session
    alt Web only
        app ->>+ sa: Validate merchant
        sa -->> app: Merchant Session
    end
    app -->> u: Present Apple Payment Sheet
    note over u, btr: Step 2 - Decrypt Apple Pay Token
    u ->> app: Authorize Payment
    app ->>+ btr: Send PKPaymentToken
    btr ->> btr: Decrypt PKPaymentToken
    btr ->> btr: Tokenize DPAN and cryptogram
    btr ->>- app: Basis Theory Tokens
    note over app, psp: Step 3 - Process Payment
    app ->>+ sa: Process CIT <br> (BT Tokens)
    sa ->> sa: Store BT Tokens
    note right of sa: Storing the Basis Theory Tokens <br> enables subsequent MITs
    sa ->>+ btp: Process CIT <br> (BT Tokens)
    btp ->> btp: Detokenize DPAN and Cryptogram
    btp ->>+ psp: Process CIT <br> (DPAN + Cryptogram)
    psp -->>- btp: Payment Response
    btp -->>- sa: Payment Response
    sa ->> sa: Store Response details
    note right of sa: This may contain a Processor reference <br> used for storing the payment method
    sa -->>- app: OK
    app -->>- u: Complete Payment
    deactivate u
```

## Merchant Initiated Transactions (MIT)

This type of transaction occurs when the Merchant process a payment using stored card information, without additional customer validation. It requires a previous CIT to collect consumer authorization. In some cases, the CIT can be a zero-dollar ($0) transaction to verify if the account is active.

Apple's Payment Sheet presented to the customer during the initial CIT workflow can contain information about the MIT, such as recurring billing amount and period, pay later and automatic reload details, etc.

In a single step, merchants can initiate transactions with the Payment Processor using the Basis Theory DPAN Token obtained from the previous workflow.

```mermaid
  sequenceDiagram
    title Merchant Initiated Transactions (MIT)

    participant sa as Server Application
    participant btp as Basis Theory <br> Proxy
    participant psp as Payment Processor

    sa ->>+ btp: Process MIT <br> (BT Token)
    btp ->>+ psp: Process MIT <br> (DPAN)
    psp -->>- btp: Payment Response
    btp -->>- sa: Payment Response
    sa ->> sa: Store Response details
```

## Collecting Payment Information

The integration between your client application and Apple can be done directly, without any interference from Basis Theory. Please follow Apple's official guides for [Web](https://developer.apple.com/documentation/apple_pay_on_the_web) ([demo](https://applepaydemo.apple.com/)) and [iOS](https://developer.apple.com/documentation/passkit_apple_pay_and_wallet/apple_pay/offering_apple_pay_in_your_app).

## Provision Resources

In this section, we will explore the bare minimum resources necessary to securely decrypt the Apple Pay Token and use it to process payments.

### Management Application

To create all subsequent resources, you will need a [Management Application](/docs/api/applications#application-types).

[Click here](https://portal.basistheory.com/applications/create?name=Resource+Creator&permissions=reactor%3Acreate&permissions=application%3Acreate&type=management) to create a Management Application or [login to your Basis Theory account](https://portal.basistheory.com/applications) and create a new application with the following settings:

- Name - Resource Creator
- Application Type - Management
- Permissions: `application:create`, `reactor:create`

<Alert>Save the API Key from the created Management Application as it will be used later in this guide.</Alert>

### Private Application

Next you will need a [Private Application](/docs/api/applications#application-types) to create tokens within the Reactor, and invoke it from your servers. This application represents your Server Application.

Using the Management Application key to authorize the request, call Basis Theory API to [create a new](/docs/api/applications/#create-application) Private Application:

```shell showLineNumbers
curl "https://api.basistheory.com/applications" \
  -X "POST" \
  -H "BT-API-KEY: <API_KEY>" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Server",
    "type": "private",
    "permissions": [ "token:create", "token:use" ]
  }'
```

<Alert>Be sure to replace <code>&lt;API_KEY></code> with the Management API Key you created previously.</Alert>

<Alert>Save the <code>key</code> and <code>id</code> from the created Private Application as it will be used later in this guide.</Alert>

### Reactor

Now let's create a [Reactor](/docs/concepts/what-are-reactors) that can decrypt Apple's `PKPaymentToken` and store the DPAN and cryptogram.

Create a `reactor.js` file and paste the code below. We will use open source [Basis Theory Apple Pay utility](https://www.npmjs.com/package/@basis-theory/apple-pay-js) to easily create a context and perform decryption.

```javascript title="reactor.js" showLineNumbers
const { Buffer } = require('buffer');
const { ApplePaymentTokenContext } = require('@basis-theory/apple-pay-js');
const {
  CustomHttpResponseError,
} = require('@basis-theory/basis-theory-reactor-formulas-sdk-js');

module.exports = async function (req) {
  const {
    bt,
    args: {
      applePayToken: { paymentData, ...restApplePayToken },
    },
    configuration: {
      MERCHANT_IDENTITY_CERTIFICATE_PEM,
      PAYMENT_PROCESSING_PRIVATE_KEY_PEM
    },
  } = req;

  // creates token context from certificates / keys configured in Reactor
  const context = new ApplePaymentTokenContext({
    merchants: [
      {
        certificatePem: Buffer.from(MERCHANT_IDENTITY_CERTIFICATE_PEM),
        privateKeyPem: Buffer.from(PAYMENT_PROCESSING_PRIVATE_KEY_PEM)
      }
      // add more certificates to perform automatic key rotation
    ]
  });

  try {
    // decrypts Apple's PKPaymentToken paymentData
    const {
      applicationPrimaryAccountNumber,
      applicationExpirationDate,
      onlinePaymentCryptogram,
      ...restPaymentData
    } = context.decrypt(paymentData);

    // vaults DPAN and cryptogram
    const { panToken, cryptogramToken } = await bt.tokenize({
      panToken: {
        type: 'card',
        data: {
          number: applicationPrimaryAccountNumber,
          expiration_month: applicationExpirationDate.slice(2, 4),
          expiration_year: `20${applicationExpirationDate.slice(-2)}`
        }
      },
      cryptogramToken: {
        type: 'token',
        containers: ['/pci/high'],
        data: onlinePaymentCryptogram
      }
    });

    // returns transaction details and vaulted tokens, without any sensitive PCI data
    return {
      raw: {
        panToken,
        cryptogramToken,
        applePayToken: {
          paymentData: restPaymentData,
          ...restApplePayToken
        }
      }
    };
  } catch (error) {
    throw new CustomHttpResponseError({
      status: 500,
      body: {
        message: error.message
      }
    });
  }
};
```

Let's store the contents of the `reactor.js` file into a variable:

```shell showLineNumbers
reactor_code=$(cat reactor.js)
```

And call Basis Theory API to create the Reactor:

```shell showLineNumbers
curl "https://api.basistheory.com/reactors" \
  -H "BT-API-KEY: <API_KEY>" \
  -H "Content-Type: application/json" \
  -X "POST" \
  -d '{
    "name": "Apple Pay Reactor",
    "code": '"$(echo $reactor_code | jq -Rsa .)"',
    "configuration": {
      "MERCHANT_IDENTITY_CERTIFICATE_PEM": "-----BEGIN CERTIFICATE-----\nMIIEdTCCBBugAwIBAgIIc5onAJBqqpk...",
      "PAYMENT_PROCESSING_PRIVATE_KEY_PEM": "-----BEGIN EC PARAMETERS-----\nBggqhkjOPQMBBw==..."
    },
    "application": {
      "id": "<APPLICATION_ID>"
    }
  }'
```

Important things to notice in the request above:

1. `<API_KEY>` is the Management Application Key, used to authenticate the request
2. `code` is passed in plain text form
3. Merchant Identifier Certificate and Payment Processing Private Key are passed in plain text form as configuration entries

<Alert>Save the <code>id</code> from the created Reactor as it will be used later to invoke it.</Alert>

Done! These are all the resources necessary. Let's see how to use them.

## Decrypting PKPaymentToken

### Creating a Session

### Authorizing a Session

### Invoking the Reactor

## Processing Payment

