---
toc_max_heading_level: 2
---

import {Alert, Alerts} from "@site/src/components/shared/Alert";
import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";
import {SdkList} from "@site/src/components/docs/SdkList";
import GettingStartedSection from "@site/src/components/docs/_getting-started-section.mdx";
import {ApplicationSection} from "@site/src/components/docs/ApplicationSection";


# Accept Google Pay

This guide will walk you through the process of accepting Google Pay in your website, while leveraging the Basis Theory platform to perform all necessary operations in PCI-sensitive data. First let's take a look at how the Google Pay payment flow works.

Firstly, you will render the Google Pay button on your page using Google's SDK's. When the user clicks the button, Google Pay will present the payment sheet to the user, which will contain the payment information (e.g., shipping details, transaction amount, card number, expiration date, etc.).

When the user clicks the Google "Pay" button, a sequence of interactions is initiated in three high-level steps:

1. Create Google Pay payment data - The client application (Android or Web) creates a payment data request object that contains the payment information and sends that request to the Google Pay API. The Google Pay API returns a payment data response object, which contains the encrypted payment information.
2. Decrypt Google Pay payment data - The encrypted payment data is sent to Basis Theory for decryption and storage of the sensitive cardholder data. Basis Theory will then return a token that can be used to process the payment.
3. Process Payment - The Basis Theory tokens are forwarded to the payment processor via Basis Theory Proxy, which translate them back to raw data before sending the request. When the successful payment response returns, the client application can complete the payment and inform the user that the payment was successful.

{/* TODO: Add a diagram here? */}

## Getting Started

### Basis Theory Setup

<GettingStartedSection/>

### Google Pay Setup

To start, we want to ensure that you're able to connect to Google's APIs. Make sure you've met all the pre-requisites in Google's [setup guide](https://developers.google.com/pay/api/web/guides/setup).

## Rendering the Google Pay Button

The integration between your client application and Google can be done directly, without any involvement from Basis Theory.

Now we'll follow Google's official guides for [Web](https://developers.google.com/pay/api/web/guides/tutorial) all the way until step 9.

```html showLineNumbers title="Create a web page with the Google Pay button"
<!DOCTYPE html>
<html>
<head>
    <title>Google Pay Integration</title>
    <script async src="https://pay.google.com/gp/p/js/pay.js" onload="onGooglePayLoaded()"></script>
    <script>
        let paymentsClient;
        let baseRequest = {
            apiVersion: 2,
            apiVersionMinor: 0,
        };
        let tokenizationSpecification = {
            type: 'PAYMENT_GATEWAY',
            parameters: {
// highlight-start
                gateway: 'basistheory',
                gatewayMerchantId: 'f338bcd6-157e-4ebf-872a-404dcfcce31e'
// highlight-end
            }
        }
        const allowedCardNetworks = ["AMEX", "DISCOVER", "INTERAC", "JCB", "MASTERCARD", "VISA"];
        const allowedCardAuthMethods = ["PAN_ONLY", "CRYPTOGRAM_3DS"];
        const baseCardPaymentMethod = {
            type: 'CARD',
            parameters: {
                allowedAuthMethods: allowedCardAuthMethods,
                allowedCardNetworks: allowedCardNetworks
            }
        };

        // Initialize Google Pay API when the library is loaded
        async function onGooglePayLoaded() {
            paymentsClient = new google.payments.api.PaymentsClient({environment: 'TEST'});
            const isReadyToPayRequest = Object.assign({}, baseRequest, {
                allowedPaymentMethods: [baseCardPaymentMethod]
            });

            try {
                // Check if the user is ready to pay
                const response = await paymentsClient.isReadyToPay(isReadyToPayRequest);
                if (response.result) {
                    createAndAddButton();
                } else {
                    console.error('Google Pay is not available.');
                }
            } catch (error) {
                console.error('Error checking readiness:', error);
            }
        }

        // Create and add the Google Pay button
        function createAndAddButton() {
            const button = paymentsClient.createButton({
                onClick: onGooglePaymentButtonClicked
            });
            document.getElementById('container').appendChild(button);
        }

        // Handle button click and load payment data
        async function onGooglePaymentButtonClicked() {
            const paymentDataRequest = Object.assign({}, baseRequest, {
                allowedPaymentMethods: [
                    Object.assign({}, baseCardPaymentMethod, {
                        tokenizationSpecification: tokenizationSpecification
                    })
                ],
                transactionInfo: {
                    totalPriceStatus: 'FINAL',
                    totalPrice: '10.00',
                    currencyCode: 'USD'
                },
                merchantInfo: {
                    merchantName: 'Example Merchant'
                }
            });

            try {
                const paymentData = await paymentsClient.loadPaymentData(paymentDataRequest);
                console.log('Payment data:', paymentData);
            } catch (error) {
                console.error('Error loading payment data:', error);
            }
        }
    </script>
</head>
<body>
<h1>Google Pay Integration</h1>
<div id="container"></div>
</body>
</html>
```

Note that for the `tokenizationSpecification`, we're setting `gateway` to `basistheory` and `gatewayMerchantId` to your tenantId created from the [Basis Theory Setup](#basis-theory-setup).

## Storing the Google Pay Payment Data with Basis Theory

### Create a Public Key

<ApplicationSection type="public" permissions={["token-intent:create"]}/>

### Tokenize the Payment Data

Now that we have access to the encrypted payment data, we can use our newly created public key to send the payment data using the [Google Pay](/docs/api/orchestration/google-pay) endpoint in the `onGooglePaymentButtonClicked` function.

```javascript showLineNumbers title="Send Google Pay token to be tokenized with Basis Theory"
async function onGooglePaymentButtonClicked() {
    const paymentDataRequest = Object.assign({}, baseRequest, {
        allowedPaymentMethods: [
            Object.assign({}, baseCardPaymentMethod, {
                tokenizationSpecification: tokenizationSpecification
            })
        ],
        transactionInfo: {
            totalPriceStatus: 'FINAL',
            totalPrice: '10.00',
            currencyCode: 'USD'
        },
        merchantInfo: {
            merchantName: 'Example Merchant'
        }
    });

    try {
        const paymentData = await paymentsClient.loadPaymentData(paymentDataRequest);
        console.log('Payment data:', paymentData);

// highlight-start
        let encryptedPaymentToken = paymentData.paymentMethodData.tokenizationData.token;
        await tokenizeGooglePayTokenWithBasisTheory(encryptedPaymentToken)
    } catch (error) {
        console.error('Error loading payment data:', error);
    }
}

// Tokenize Google Pay data using Basis Theory
async function tokenizeGooglePayTokenWithBasisTheory(encryptedPaymentToken) {
    const response = await fetch('https://api.basistheory.com/connections/google-pay/tokenize', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'BT-API-KEY': '<PUBLIC_API_KEY>'
        },
        body: JSON.stringify({
            google_payment_method_token: encryptedPaymentToken
        })
    });

    return await response.json();
}
// highlight-end
```

  The result of this call will be a [token intent](/docs/api/tokens/token-intents#token-intent-object) that you can use to process the payment. The type of token intent will either be `card` or `network_token` depending on the `AuthMethod` of the card that was available for the GPay token.

  {/*
  TODO: point out the differences between a card and network token and FPANs vs DPANs
  */}

  ## Processing the GPay token

  ### Create a Private Key

  <ApplicationSection type="private" permissions={["token-intent:use"]}/>

  ### Charge a Card

  Payment service providers (PSPs) may differ in how they handle this operation, offering workflows like "authorization and capture" or "direct charge."

    In Adyen, you can charge a card by creating a [payment](https://docs.adyen.com/api-explorer/Checkout/latest/post/payments).

  {/*
  TODO: find out what key to use for this Adyen call
  */}
```shell showLineNumbers title="Create a transaction"
curl 'https://api.basistheory.com/proxy' \
-X 'POST' \
// highlight-start
-H 'BT-API-KEY: <PRIVATE_API_KEY>' \
-H 'BT-PROXY-URL: https://checkout-test.adyen.com/v71/payments' \
-H 'Authorization: Bearer <REPLACE_ME>' \
// highlight-end
-H 'Content-Type: application/json' \
-d '{
  "amount": {
    "currency": "USD",
    "value": 1000
  },
// highlight-start
  "paymentMethod": {
    "type": "scheme",
    "number": "{{ token_intent: d2cbc1b4-5c3a-45a3-9ee2-392a1c475ab4 | json: \"$.data.number\" }}",
    "expiryMonth": "{{ token_intent: d2cbc1b4-5c3a-45a3-9ee2-392a1c475ab4 | json: \"$.data\" | card_exp: \"MM\" }}",
    "expiryYear": "{{ token_intent: d2cbc1b4-5c3a-45a3-9ee2-392a1c475ab4 | json: \"$.data\" | card_exp: \"YYYY\" }}",
    "brand": "googlepay"
  },
// highlight-end
  "mpiData": {
    "directoryResponse": "Y",
    "authenticationResponse": "Y",
// highlight-start
    "cavv": "{{ token_intent: d2cbc1b4-5c3a-45a3-9ee2-392a1c475ab4 | json: \"$.data.authentication.threeds_cryptogram\" }}",
    "eci": "{{ token_intent: d2cbc1b4-5c3a-45a3-9ee2-392a1c475ab4 | json: \"$.data.authentication.eciIndicator\" }}"
// highlight-end
  },
  "additionalData": {
    "paymentdatasource.type": "googlepay",
    "paymentdatasource.tokenized": "true"
  },
  "shopperInteraction": "Ecommerce"
}'
```

<Alert>You are not restricted to only using Adyen. You can use any payment processor that accepts Google Pay tokens.</Alert>

  ## Preparing for Production

  Once you're ready for production, you'll want to publish your integration with Google Pay by following the [official guide](https://developers.google.com/pay/api/web/guides/test-and-deploy/publish-your-integration). Once you have your official `merchantId`, you can update your `merchantId` in the payment data request to Google Pay, and change the `environment` to `PRODUCTION`.
