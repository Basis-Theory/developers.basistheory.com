---
title: Proxy
---

import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";

# Proxy

 Proxy Expressions allow the ability to inject header values before forwarding the request to the destination. Using these expressions you
 can reference the [detokenized](/docs/expressions/detokenization) request body, other headers and even the configuration of the
 [Pre-Configured Proxy](/docs/api/proxies/pre-configured-proxies).
 A useful example would be computing a signature required by the destination to verify data integrity and authenticity of the request.

## New Transform Expressions

Basis Theory Proxy supports two new powerful expressions for working with tokenized data in your proxy pipeline:

### Tokenize Transform Expression

The `tokenize_transform` expression allows you to reference tokens created by [request transforms](/docs/api/proxies/pre-configured-proxies#tokenize-request-transforms) within your request body. This enables you to:

- Access token properties (id, data, metadata, etc.) after tokenization
- Build request payloads that include both token references and token data
- Create dynamic requests based on tokenized content

#### Syntax
```liquid
{{ tokenize_transform: 'identifier_name' | json: '$.property_path' }}
```

#### Example Usage

Given a proxy with a tokenize request transform:

```json showLineNumbers
{
  "request_transforms": [
    {
      "type": "tokenize",
      "options": {
        "token": {
          "type": "card",
          "data": "{{ encrypted | json: '$.card_data' }}",
          "metadata": {
            "customer_id": "12345"
          }
        },
        "identifier": "payment_card"
      }
    }
  ]
}
```

You can reference this token in your request body:

```json showLineNumbers
{
  "token_id": "{{ tokenize_transform: 'payment_card' | json: '$.id' }}",
  "card_brand": "{{ tokenize_transform: 'payment_card' | json: '$.card.brand' }}",
  "card_last_four": "{{ tokenize_transform: 'payment_card' | json: '$.card.last4' }}",
  "customer": "{{ tokenize_transform: 'payment_card' | json: '$.metadata.customer_id' }}",
  "processing_info": {
    "tokenized_at": "{{ tokenize_transform: 'payment_card' | json: '$.created_at' }}",
    "token_type": "{{ tokenize_transform: 'payment_card' | json: '$.type' }}"
  }
}
```

### Transform Identifier Expression

The `transform_identifier` expression allows you to reference tokens created by request transforms within response transforms. This enables you to:

- Inject token IDs into API responses
- Add token metadata to response payloads
- Create audit trails linking requests to tokens

#### Syntax
```liquid
{{ transform_identifier: 'identifier_name' | json: '$.property_path' }}
```

#### Example Usage

Using the same tokenize request transform, you can reference it in response transforms:

```json showLineNumbers
{
  "response_transforms": [
    {
      "type": "append_json",
      "options": {
        "value": "{{ transform_identifier: 'payment_card' | json: '$.id' }}",
        "location": "$.payment.token_id"
      }
    },
    {
      "type": "append_json",
      "options": {
        "value": "{{ transform_identifier: 'payment_card' | json: '$.fingerprint' }}",
        "location": "$.payment.card_fingerprint"
      }
    }
  ]
}
```

This would transform a response like:

```json title="Original Response"
{
  "payment": {
    "amount": 1000,
    "currency": "USD",
    "status": "processed"
  }
}
```

Into:

```json title="Transformed Response"
{
  "payment": {
    "amount": 1000,
    "currency": "USD", 
    "status": "processed",
    "token_id": "tok_ABC123XYZ789",
    "card_fingerprint": "CC2XvyoohnqecEq4r3FtXv6MdCx4"
  }
}
```

## Signing the request using HMAC-SHA256

Given a Pre-Configured proxy with the following configuration:

```json showLineNumbers
{
  ...
  "configuration": {
    "secret_key": "my-secret-key",
    "another_secret": "my-secret"
  },
  ...
}
```

Then a request containing the proxy expression:

```json showLineNumbers
curl --location --request POST 'https://api.basistheory.com/proxy?bt-proxy-key=<proxy_key>' \
--header 'X-User-Id: 2342424' \
--header 'X-Date: 2024-07-10T13:46:28.629Z' \
--header 'Content-Type: application/json' \
--header 'Authorization: {{ proxy | json: '$.request.headers.X-User-Id' | append: proxy.request.headers.X-Date | append: proxy.request.body \
  | hmac: 'sha-256', proxy.config.secret_key | to_base16 }}' \
--data '{ "card_number": "{{ token: 1d08babf-456a-4bef-993d-aece3c1a2f66 | '$.data.number' }}" }'
```

will concatenate `X-User-Id` + `X-Date` + `<request_body_json_string>`, compute the signature using `HMAC` with `SHA-256` and then `base16` encode it:

```json showLineNumbers
Authorization: 1bd337f9d892a7f4581b998c21e353b1686a6bcac5940e7bb6aa596c96e0a6ed
```
